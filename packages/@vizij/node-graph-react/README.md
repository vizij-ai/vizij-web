# @vizij/node-graph-react

React bindings for the Vizij node-graph runtime. This package wraps the
`@vizij/node-graph-wasm` module with a context provider, selector hooks, and
utility helpers so React apps can load, evaluate, and interact with Vizij graphs.

## Installation

```bash
npm install @vizij/node-graph-react @vizij/node-graph-wasm
```

Ensure `@vizij/node-graph-wasm` has been built/linked from the `vizij-rs` repo
when working locally.

## Usage

```tsx
import React from "react";
import {
  NodeGraphProvider,
  useNodeGraph,
  useNodeOutput,
} from "@vizij/node-graph-react";
import type { GraphSpec } from "@vizij/node-graph-wasm";

const spec: GraphSpec = {
  nodes: [
    {
      id: "time",
      type: "time",
      params: {},
      inputs: {},
    },
    {
      id: "sine",
      type: "sin",
      params: {},
      inputs: { in: { node_id: "time", output_key: "out" } },
    },
  ],
};

function Panel() {
  const { ready, setTime } = useNodeGraph();
  const snapshot = useNodeOutput("sine");
  if (!ready) return <p>Loading…</p>;
  return (
    <div>
      <p>sin(t): {snapshot?.value.float?.toFixed(3)}</p>
      <button onClick={() => setTime(0)}>Reset</button>
    </div>
  );
}

export default function App() {
  return (
    <NodeGraphProvider spec={spec} autostart>
      <Panel />
    </NodeGraphProvider>
  );
}
```

### Provider props

| Prop        | Description                                                                                                       |
| ----------- | ----------------------------------------------------------------------------------------------------------------- |
| `spec`      | Graph spec (`GraphSpec` or JSON string) loaded on mount and when the reference changes.                           |
| `autostart` | When `true` (default) the provider runs an internal RAF loop that calls `step(dt)` and `evalAll()` automatically. |
| `updateHz`  | Optional throttle in Hz for UI notifications (e.g. `30` → ~33 ms).                                                |

### Context API (`useNodeGraph`)

- `ready`: true once the wasm module has been initialized and the initial spec is loaded.
- `setParam(nodeId, key, value)`: update a node parameter and re-evaluate immediately.
  Supports numbers, booleans, vectors, `ValueJSON`, or plain strings (for
  parameters such as `path` on `output` nodes).
- `reload(spec)`: replace the graph spec at runtime.
- `setTime(t)`: set absolute evaluation time (seconds).
- `subscribeToNode(nodeId, cb)`: low-level subscription helper.
- `getNodeOutputSnapshot(nodeId, key)` / `getNodeOutput(nodeId)`: read the latest cached outputs.
- `subscribeToWrites(cb)` / `getWrites()` / `clearWrites()`: observe and acknowledge write operations emitted via `Output` nodes (see `useGraphWrites`).

### Selector hooks

- `useNodeOutput(nodeId, key = "out")` → `PortSnapshot | undefined`
- `useNodeOutputs(nodeId)` → cloned map of `PortSnapshot`
- `useGraphWrites()` → `WriteOpJSON[]`

`PortSnapshot` matches the wasm result shape: `{ value: ValueJSON, shape: ShapeJSON }`.

### Utilities

The module exports helpers like `valueAsNumber`, `valueAsVec3`, etc. to coerce
`ValueJSON`/`PortSnapshot` objects into convenient primitives for UI components.

## Notes

- Call `init()` from `@vizij/node-graph-wasm` once per application before
  instantiating the provider (the provider does this automatically on mount).
- Specs are normalized on load to accept shorthand value literals, but complex
  shapes/metadata should be provided using the serialized forms generated by the
  Rust core.
- The demo application in `apps/demo-node-graph` showcases the provider in a
  React Flow editor with live evaluation.
